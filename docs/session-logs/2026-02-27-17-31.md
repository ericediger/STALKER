# Session Log — 2026-02-27 17:31

## Summary

Implemented advisor context window management across 6 phases, resolving the last two functional limitations (KL-2: context window not managed, KL-3: no summary generation). Long advisor threads now automatically trim older messages to stay within the LLM's context window, and trimmed messages are compressed into LLM-generated rolling summaries stored in the database.

## Changes Made

### New Files (7)
- `packages/advisor/src/token-estimator.ts` — Character-ratio heuristic (3.0–3.5 chars/token) for conservative token estimation
- `packages/advisor/src/context-budget.ts` — Budget allocation constants (174,700 tokens for messages after reserves)
- `packages/advisor/src/context-window.ts` — Message windowing algorithm, turn-boundary trimming, tool orphan prevention
- `packages/advisor/src/summary-generator.ts` — LLM-generated rolling summaries, fire-and-forget, graceful degradation
- `packages/advisor/__tests__/token-estimator.test.ts` — 10 tests
- `packages/advisor/__tests__/context-window.test.ts` — 11 tests
- `packages/advisor/__tests__/summary-generator.test.ts` — 6 tests

### Modified Files (10)
- `packages/advisor/src/index.ts` — Barrel exports for new modules
- `packages/advisor/__tests__/exports.test.ts` — +2 tests for new exports
- `apps/web/src/app/api/advisor/chat/route.ts` — Windowing integration, summary preamble, fire-and-forget summary generation
- `apps/web/src/app/api/advisor/threads/[id]/route.ts` — `hasSummary` field on GET response
- `apps/web/__tests__/api/advisor/chat.test.ts` — +4 new tests, updated mocks
- `apps/web/__tests__/api/advisor/threads.test.ts` — +2 tests for hasSummary
- `apps/web/src/components/advisor/AdvisorMessages.tsx` — Info banner when messages summarized
- `apps/web/src/components/advisor/AdvisorPanel.tsx` — Wire hasSummary prop
- `apps/web/src/lib/hooks/useAdvisor.ts` — hasSummary state management

### Documentation (4)
- `HANDOFF.md` — Full rewrite with S19 state
- `CLAUDE.md` — Session 19 section added
- `AGENTS.md` — Test count (718), context window management decision
- `KNOWN-LIMITATIONS.md` — KL-2, KL-3 closed

## Key Decisions

| # | Decision | Rationale |
|---|----------|-----------|
| AD-S19-1 | Token estimation via character-ratio heuristic | Conservative overestimation is safe. No external dependency. |
| AD-S19-2 | Turn-boundary trimming only | Prevents orphaned tool results or context-free assistant responses. |
| AD-S19-3 | Summary triggered by windowing signal | Clean separation of concerns between detection and execution. |
| AD-S19-4 | Same LLM adapter for summaries | Low cost (~1,800 tokens/summary), reuses infrastructure. |
| AD-S19-5 | Fire-and-forget summary generation | User gets response immediately. Failure degrades gracefully. |
| AD-S19-6 | summaryText internal only | Users see indicator, not raw summary. Cleaner UX. |

## Issues & Blockers

None. All 6 phases delivered with zero scope cuts.

Bugs fixed during session:
1. MIN_RECENT_MESSAGES guard caused test failures with too few turns — fixed test data
2. Type mismatch between WindowableMessage and prismaMessageToInternal — created separate converter
3. Truncated test function signature in threads.test.ts — restored

## Next Steps

1. **Responsive refinements** — Tablet/mobile layout adjustments (only remaining post-MVP priority)
2. No functional limitations remain (KL-4–6 are operational trade-offs with documented mitigations)
