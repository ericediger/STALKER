# Session Log — 2026-02-25 21:00

## Summary

Session 14 addressed three critical post-UAT issues: bulk import idempotency (dedup guard), snapshot rebuild performance (from minutes to ~4 seconds), and instrument name resolution (78 instruments resolved). A full UAT acceptance criteria sweep was also conducted, with all 11 MVP criteria passing against the real 83-instrument portfolio.

## Changes Made

### Phase 0: Data Integrity
- `apps/web/src/app/api/transactions/bulk/route.ts` — Added dedup guard using Decimal.eq() comparison on (instrumentId, type, quantity, price, tradeAt). Skipped rows reported in response.
- `apps/web/src/app/api/transactions/route.ts` — Added `potentialDuplicate` warning field to POST response.
- `apps/web/src/components/transactions/BulkPastePanel.tsx` — Updated toast to show "Imported N. Skipped M duplicates."
- `apps/web/src/lib/hooks/useBulkImport.ts` — Added `skipped` field to BulkImportResult type.
- `apps/web/__tests__/api/transactions/bulk.test.ts` — 4 new dedup tests.

### Phase 1: Snapshot Rebuild Performance
- `apps/web/src/lib/batch-price-lookup.ts` — New BatchPriceLookup class: pre-loads all price bars via single query, O(1) exact lookups, O(log n) carry-forward via binary search.
- `apps/web/src/lib/snapshot-rebuild-helper.ts` — Switched from per-query PrismaPriceLookup to BatchPriceLookup. Timeout reduced from 600s to 60s.
- `scripts/benchmark-rebuild.ts` — Benchmark script for measuring rebuild performance.

### Phase 2: Instrument Name Resolution
- `scripts/resolve-instrument-names.ts` — One-time script: FMP search + Tiingo metadata fallback. Resolved all 78 unnamed instruments.
- `apps/web/src/lib/auto-create-instrument.ts` — Added Tiingo metadata fallback when FMP search returns nothing.

### Phase 3: UAT Acceptance Sweep
- All 11 MVP acceptance criteria verified via API testing.
- Advisor tested with 2 intent categories (concentration awareness, tax-aware reasoning).

## Key Decisions

| # | Decision | Rationale |
|---|----------|-----------|
| AD-S14-1 | Dedup by exact match on 5 fields | Conservative approach avoids false positives |
| AD-S14-2 | Decimal.eq() for dedup comparison | String comparison fails on "50" vs "50.00" |
| AD-S14-3 | BatchPriceLookup with binary search | Single query + in-memory map replaces ~20K individual queries |
| AD-S14-4 | Name resolution as manual script | FMP calls expensive (250/day), one-time operation |

## Issues & Blockers

- LatestQuote table mostly empty (only 3 of 83 instruments have quotes). FMP rate limit (5/min, 250/day) means the scheduler needs multiple days to fully populate quotes for 83 instruments.
- Visual browser checks for UI rendering were not completed (user initiated wrap-up).

## Next Steps

1. **Visual UAT in browser** — Verify chart rendering, UI layout, toast messages, advisor panel
2. **Holiday/half-day market calendar** — Reduce wasted API calls
3. **Advisor context window management** — Token counting for long threads
4. **Responsive refinements** — Tablet/mobile layout
