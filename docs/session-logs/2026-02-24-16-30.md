# Session Log — 2026-02-24 16:30

## Summary

Session 11 migrated all market data providers from mocked configurations to real API-compatible implementations. FMP was migrated from the dead `/api/v3/` namespace to `/stable/` endpoints, Stooq was replaced by a new Tiingo provider for historical bars, and the provider chain was rewired end-to-end. All 526 tests pass with fixtures matching real API response shapes.

## Changes Made

### New Files
- `packages/market-data/src/providers/tiingo.ts` — New TiingoProvider implementing MarketDataProvider (history + quotes + no search)
- `packages/market-data/__tests__/tiingo.test.ts` — 17 tests covering history, quotes, error handling, BRK-B symbol
- `packages/market-data/__tests__/fixtures/tiingo-history.json` — Tiingo daily bar fixture from real API
- `packages/market-data/__tests__/fixtures/tiingo-brk-b.json` — BRK-B fixture for hyphen symbol format
- `data/test/provider-smoke-results.md` — Phase 0 smoke test findings
- `data/test/smoke-responses/` — 6 raw API response JSON files

### Modified Files
- `packages/market-data/src/providers/fmp.ts` — Full rewrite: `/api/v3/` → `/stable/`, new field names, getHistory disabled
- `packages/market-data/src/providers/stooq.ts` — Added deprecation comment
- `packages/market-data/src/rate-limiter.ts` — Added per-hour sliding window bucket
- `packages/market-data/src/service.ts` — Removed FMP history fallback, updated comments for Tiingo
- `packages/market-data/src/index.ts` — Export TiingoProvider, mark StooqProvider as deprecated
- `packages/market-data/src/symbol-map.ts` — Updated comment (Stooq → Tiingo example)
- `packages/shared/src/types/index.ts` — Added `requestsPerHour?: number` to ProviderLimits
- `packages/scheduler/src/config.ts` — Added tiingoApiKey, tiingoRph, tiingoRpd
- `packages/scheduler/src/index.ts` — Replaced StooqProvider with TiingoProvider
- `packages/market-data/__tests__/fmp.test.ts` — Updated for /stable/ API, removed history tests, added URL verification
- `packages/market-data/__tests__/fallback.test.ts` — Updated for Tiingo history provider, removed FMP history fallback test
- `packages/market-data/__tests__/fixtures/fmp-search.json` — Updated to /stable/ response shape
- `packages/market-data/__tests__/fixtures/fmp-quote.json` — Updated to /stable/ response shape
- `apps/web/.env.local` — Added TIINGO_RPH=50 and TIINGO_RPD=1000

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| AD-S11-1: Tiingo replaces Stooq | Stooq has no formal API, IP-rate-limiting, CAPTCHA risk. Tiingo provides proper REST API. |
| AD-S11-2: FMP reduced to search + quotes | FMP free tier no longer includes historical EOD data. |
| AD-S11-3: Use Tiingo adjusted prices | Adjusted prices account for splits and dividends automatically. |
| AD-S11-4: Number → String → Decimal | `toDecimal(String(272.11))` avoids float contamination from JSON numbers. |

## Issues & Blockers

- None blocking. All exit criteria passed (14/14).
- API route stubs (search, refresh, backfill) still not wired to live providers — deferred to next session.

## Next Steps

1. Wire API route stubs to live MarketDataService (search, refresh, historical backfill)
2. Test end-to-end with `pnpm dev` and real API keys
3. Holiday/half-day market calendar improvements
4. Advisor context window management
