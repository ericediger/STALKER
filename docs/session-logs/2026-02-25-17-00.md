# Session Log — 2026-02-25 17:00

## Summary

Session 13 was a UAT (User Acceptance Testing) session where the business stakeholder operated the browser while the engineer diagnosed and applied real-time hotfixes. Over 12 UX issues were identified and resolved, covering search, forms, charts, navigation, and bulk import. The user successfully imported their real portfolio (~83 instruments, 87 transactions) and data was verified correct after duplicate cleanup and backfill.

## Changes Made

### UX Hotfixes (Commits 1-3)
- `apps/web/src/components/instruments/SymbolSearchInput.tsx` — Min 3 chars, max 10 results, scrollable dropdown, clears on select, full SearchResult callback
- `apps/web/src/components/instruments/AddInstrumentModal.tsx` — Auto-populate from search, exchange/type mapping, optional initial purchase section with price auto-fill
- `apps/web/src/app/(pages)/page.tsx` — Show instruments without transactions, persistent "+ Add Instrument" button
- `apps/web/src/app/(pages)/holdings/page.tsx` — Same instrument visibility fix, persistent add button
- `apps/web/src/components/transactions/TransactionForm.tsx` — Price auto-fill from historical close
- `apps/web/src/components/dashboard/PortfolioChart.tsx` — Always render container div (invisible during loading)
- `apps/web/src/components/holding-detail/CandlestickChart.tsx` — Same chart rendering fix
- `apps/web/src/lib/hooks/usePortfolioTimeseries.ts` — Send startDate=1970-01-01 for ALL window

### Auto-Create Instruments (Commits 4-5)
- `apps/web/src/lib/auto-create-instrument.ts` — NEW: findOrCreateInstrument() + triggerBackfill() shared helper
- `apps/web/src/app/api/transactions/bulk/route.ts` — Auto-create instruments instead of rejecting unknown symbols; sequential backfills; fire-and-forget rebuild
- `apps/web/src/app/api/transactions/route.ts` — Accept symbol as alternative to instrumentId
- `apps/web/src/components/transactions/BulkPastePanel.tsx` — Show auto-created instruments in toast
- `apps/web/src/lib/snapshot-rebuild-helper.ts` — Timeout increased to 10 minutes

### Data Cleanup (Commit 6)
- `scripts/backfill-missing.ts` — NEW: One-off backfill script for instruments missing price data
- Manual DB cleanup: deleted 168 duplicate transactions, backfilled 71 instruments, rebuilt 826 snapshots

### Tests Updated (Commits 4-5)
- `apps/web/__tests__/api/transactions/bulk.test.ts` — Changed "rejects unknown symbols" to "auto-creates instruments"
- `apps/web/__tests__/api/transactions/transactions.test.ts` — Changed "404 for unknown instrument" to "auto-creates instrument"

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| Chart container always in DOM | TradingView createChart() needs a real DOM element during useEffect mount. Conditional rendering caused null ref. |
| Skip backfill during bulk instrument creation | SQLite single-writer lock causes timeouts with concurrent fire-and-forget backfills. |
| Fire-and-forget snapshot rebuild for bulk | 80+ instrument rebuild takes minutes; API shouldn't block. |
| 10-minute Prisma transaction timeout | 30s and 120s both insufficient for 80-instrument snapshot rebuild. |

## Issues & Blockers

- **Bulk import lacks idempotency** — User imported 3x, creating triple duplicates. No dedup detection exists.
- **Auto-created instrument names** — Many instruments have symbol as name (e.g., "CXDO" instead of "Crexendo Inc.") because FMP search returned no results for some tickers.
- **Snapshot rebuild performance** — Scales poorly with instrument count (80 instruments = minutes).

## Next Steps

1. Add bulk import duplicate detection (by instrumentId + type + quantity + price + tradeAt)
2. Batch FMP lookup to resolve instrument names for auto-created entries
3. Continue UAT phases 1-6 from SESSION-13-PLAN.md
4. Holiday/half-day market calendar
5. Advisor context window management
