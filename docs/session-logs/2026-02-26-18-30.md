# Session Log — 2026-02-26 18:30

## Summary

Session 18 resolved 5 issues discovered during the first visual browser UAT with the real 83-instrument portfolio. Extended price bar history to cover the full portfolio timeline (Dec 2022+), improved holdings table columns with average cost, added resilient refetch with retry logic, preserved table pagination state on delete, and added "Add Another" to the instrument creation flow.

## Changes Made

### Phase 1 — Backfill Lookback Extended to 10 Years (P0)
- `apps/web/src/app/api/instruments/route.ts` — Changed backfill lookback from 2yr to 10yr
- `apps/web/src/lib/auto-create-instrument.ts` — Same 2yr → 10yr fix
- `scripts/backfill-missing.ts` — Same 2yr → 10yr fix
- `scripts/re-backfill-history.ts` — **NEW** one-time re-backfill script (batches of 45, 60s pause, date-range dedup)
- Result: 12,748 new bars across 73 instruments. Portfolio snapshots now cover Dec 29, 2022 – present (813 snapshots).

### Phase 2 — Holding Detail Resilient Refetch (P1)
- `apps/web/src/app/api/portfolio/holdings/[symbol]/route.ts` — Added console.error logging with symbol context
- `apps/web/src/lib/hooks/useHoldingDetail.ts` — Retry once on HTTP 500 with 500ms delay; error messages include server body

### Phase 3 — Holdings Table Column Improvements (P2)
- `apps/web/src/lib/holdings-utils.ts` — Added `avgCostPerShare()` function (Decimal division, zero-guard), added "avgCost" to SortColumn type
- `apps/web/src/components/dashboard/PortfolioTable.tsx` — Added "Avg Cost" column, renamed "Price" → "Current Price", reordered columns
- `apps/web/src/components/holdings/HoldingsTable.tsx` — Renamed "Price" → "Current Price"
- `apps/web/src/lib/__tests__/holdings-utils.test.ts` — 6 new tests (avgCostPerShare + sort)

### Phase 4 — List Position Preservation (P3)
- `apps/web/src/lib/hooks/useHoldings.ts` — Only show loading skeleton on initial load (data === null), not on refetch

### Phase 5 — Add Another Instrument (P4)
- `apps/web/src/components/instruments/AddInstrumentModal.tsx` — Success state with "Add Another" and "Done" buttons after instrument creation

### Phase 6 — Documentation Sync
- `HANDOFF.md` — Updated to post-Session 18 state
- `KNOWN-LIMITATIONS.md` — Updated date header
- `CLAUDE.md` — Added Session 18 section
- `AGENTS.md` — Updated test count (677 → 683)

## Key Decisions

| # | Decision | Rationale |
|---|----------|-----------|
| AD-S18-1 | Backfill lookback extended to 10 years | Tiingo provides 30+ years free data. 10yr covers any reasonable transaction history. |
| AD-S18-2 | Holding detail refetch retries once on 500 | Transient SQLite contention. Single retry with 500ms delay resolves most cases. |
| AD-S18-3 | Avg Cost = costBasis / totalQuantity (Decimal) | Standard brokerage column. Guards divide-by-zero for fully closed positions. |
| AD-S18-4 | Re-backfill is a one-time script | Existing instruments needed gap fill. Future instruments get 10yr automatically. |
| AD-S18-5 | useHoldings skips loading skeleton on refetch | Prevents PortfolioTable unmount that destroyed pagination/scroll state. |

## Issues & Blockers

- 3 instruments (XRP, QTOP, TOPT) still have price bar gaps — Tiingo doesn't carry these. Accepted as data limitation.
- Phase 2 root cause (HTTP 500) could not be definitively identified — rebuild is already synchronous. Likely transient SQLite contention. Defensive retry mitigates.

## Next Steps

1. Advisor context window management (KL-2/KL-3) — token counting, summary generation
2. Responsive refinements — tablet/mobile layout adjustments
