# Session Log — 2026-02-24 17:28

## Summary

Session 12 closed the last integration gap in STALKER by wiring three remaining API stubs (search, refresh, instrument backfill) to live market data providers. A Lead + 2 Parallel Teammates pattern was used: the lead completed Phase 0 (API wiring + live verification), then launched hardening-engineer and pipeline-soak-engineer in parallel. The session added 72 new tests (526 to 598) and eliminated all API stubs.

## Changes Made

### Phase 0 (Lead)
- **`apps/web/src/lib/market-data-service.ts`** — New singleton factory `getMarketDataService()` initializing FMP, Tiingo, AlphaVantage providers from env vars
- **`apps/web/src/app/api/market/search/route.ts`** — Replaced stub with live FMP search via `MarketDataService.searchSymbols()`
- **`apps/web/src/app/api/market/refresh/route.ts`** — Replaced stub with iteration over all instruments, calling `getQuote()` per instrument
- **`apps/web/src/app/api/instruments/route.ts`** — Added Tiingo historical backfill on instrument creation; updated providerSymbolMap from `stooq` to `tiingo`
- **`apps/web/__tests__/api/instruments/instruments.test.ts`** — Updated to expect `tiingo` key and mock `market-data-service`

### Hardening Engineer (Teammate)
- **`packages/market-data/__tests__/tiingo-rate-limit-regression.test.ts`** — 6 tests for Tiingo HTTP 200 rate limit detection
- **`packages/market-data/__tests__/rate-limiter-hour.test.ts`** — 10 tests for per-hour sliding window bucket
- **`apps/web/__tests__/api/transactions/decimal-precision.test.ts`** — 4 tests for Decimal precision round-trip
- **`packages/market-data/__tests__/fallback-chain.test.ts`** — 5 tests for provider fallback behavior
- **`KNOWN-LIMITATIONS.md`** — Updated with resolved items and new limitations (KL-1 through KL-6)

### Pipeline Soak Engineer (Teammate)
- **`data/test/soak-instruments.json`** — 15 real instruments fixture
- **`data/test/backfill-quality.test.ts`** — 18 tests for backfill data quality invariants
- **`data/test/symbol-mapping.test.ts`** — 11 tests for provider symbol resolution
- **`data/test/market-data-service.test.ts`** — 18 tests for MarketDataService integration

### Documentation (Lead)
- **`HANDOFF.md`** — Updated to Session 12 state
- **`CLAUDE.md`** — Updated search/refresh endpoints to "Implemented"
- **`AGENTS.md`** — Updated test count to 598+
- **`STALKER_MASTER-PLAN.md`** — Updated to v4.0
- **`SESSION-12-KICKOFF.md`**, **`SESSION-12-PLAN.md`** — Session planning docs

## Key Decisions

| # | Decision | Rationale |
|---|----------|-----------|
| AD-S12a | `getMarketDataService()` singleton factory | One instance, all providers, avoids constructing providers per request |
| AD-S12b | Fire-and-forget backfill in instrument creation | Response returns immediately; backfill runs async. Single user, sub-5s typical |
| AD-S12c | providerSymbolMap uses `tiingo` (replaced `stooq`) | Tiingo is the active history provider. Dots to hyphens mapping (BRK.B to BRK-B) |
| SQLite compat | Removed `skipDuplicates` from `createMany()` | Prisma SQLite does not support `skipDuplicates` |

## Issues & Blockers

- **SQLite `skipDuplicates` not supported**: Discovered during V-3 verification. Fixed by removing the option. No duplicate bars expected for fresh instruments.
- **Rate limiting during V-2**: Only 4/28 seed instruments refreshed due to 5 RPM FMP rate limit. Expected behavior — not a bug.

## Next Steps

1. **Session 13 (UAT)**: Real portfolio data entry, cross-validation against brokerage statements
2. Full E2E smoke test with 15 soak instruments added via UI
3. Holiday/half-day market calendar improvements
4. Advisor context window management
